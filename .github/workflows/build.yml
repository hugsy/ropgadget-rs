name: CI Build

on:
  push:
  workflow_dispatch:

env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
  PROJECT_NAME: "rp-rs"
  REPO: hugsy/rp-rs
  VERBOSE: "1"
  RUST_BACKTRACE: 1

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: ['ubuntu-latest']
        target:
        - i686-unknown-linux-gnu
        - aarch64-unknown-linux-gnu
        - i686-pc-windows-msvc
        - x86_64-pc-windows-msvc
        - x86_64-apple-darwin

    name: "build_${{ matrix.target }}"
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4

      - name: Install rust
        uses: actions-rs/toolchain@v1
        with:
            toolchain: nightly
            override: true
            target: ${{ matrix.target }}

      - name: Cargo build
        uses: actions-rs/cargo@v1
        with:
          use-cross: true
          command: build
          args: --release --verbose --color always --target ${{ matrix.target }}

      - name: Prepare artifact
        shell: bash
        run: |
          mkdir build
          cp -v target/release/rp-rs* build/

      - name: Publish artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.PROJECT_NAME}}_${{ matrix.target}}_${{ env.GITHUB_REF_SLUG }}_${{ env.GITHUB_SHA_SHORT }}
          path: build/
