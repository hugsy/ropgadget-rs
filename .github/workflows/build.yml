name: CI Build

on:
  push:
  workflow_dispatch:

env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
  PROJECT_NAME: "rp-rs"
  REPO: hugsy/rp-rs
  VERBOSE: "1"
  RUST_BACKTRACE: 1

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        job:
          - { os: ubuntu-latest,  target: arm-unknown-linux-gnueabihf , use-cross: true }
          - { os: ubuntu-latest,  target: arm-unknown-linux-musleabihf, use-cross: true }
          - { os: ubuntu-latest,  target: aarch64-unknown-linux-gnu   , use-cross: true }
          - { os: ubuntu-latest,  target: i686-unknown-linux-gnu      , use-cross: true }
          - { os: ubuntu-latest,  target: i686-unknown-linux-musl     , use-cross: true }
          - { os: ubuntu-latest,  target: x86_64-unknown-linux-gnu    , use-cross: true }
          - { os: ubuntu-latest,  target: x86_64-unknown-linux-musl   , use-cross: true }
          - { os: macos-latest,   target: x86_64-apple-darwin         , use-cross: false}
          - { os: windows-latest, target: aarch64-pc-windows-msvc     , use-cross: false}
          - { os: windows-latest, target: i686-pc-windows-msvc        , use-cross: false}
          - { os: windows-latest, target: x86_64-pc-windows-gnu       , use-cross: false}
          - { os: windows-latest, target: x86_64-pc-windows-msvc      , use-cross: false}

    name: "${{ matrix.job.os }} / ${{ matrix.job.target }}"
    runs-on: ${{ matrix.job.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4

      - name: Install prerequisites
        shell: bash
        run: |
          case ${{ matrix.job.target }} in
            arm-unknown-linux-*) sudo apt-get -y update ; sudo apt-get -y install gcc-arm-linux-gnueabihf ;;
            aarch64-unknown-linux-gnu) sudo apt-get -y update ; sudo apt-get -y install gcc-aarch64-linux-gnu ;;
          esac

      - name: Install rust
        uses: actions-rs/toolchain@v1
        with:
            toolchain: nightly
            override: true
            target: ${{ matrix.job.target }}

      - name: Show version information (Rust, cargo, GCC)
        shell: bash
        run: |
          gcc --version || true
          rustup -V
          rustup toolchain list
          rustup default
          cargo -V
          rustc -V

      - name: Cargo build
        uses: actions-rs/cargo@v1
        with:
          use-cross: ${{ matrix.job.use-cross }}
          command: build
          args: --release --verbose --target ${{ matrix.job.target }}

      - name: Prepare artifact
        shell: bash
        run: |
          mkdir build
          cargo install --path . --root build

      - name: Publish artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.PROJECT_NAME}}_${{ matrix.job.os}}_${{ matrix.job.target}}_${{ env.GITHUB_REF_SLUG }}_${{ env.GITHUB_SHA_SHORT }}
          path: build/bin
